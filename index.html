<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Namastakip</title>

<style>
:root{
  --bg1:#35d0d6;
  --bg2:#0aa0a8;
  --panel:rgba(8,20,24,.75);
  --panel2:rgba(8,20,24,.6);
  --text:#ecfbff;
  --muted:#c9f3f7;
  --line:rgba(255,255,255,.18);

  --kaza:#111;        /* schwarz */
  --farz:#ff5a5a;    /* rot */
  --sunnet:#ffd84d;  /* gelb */
  --cemaat:#35e38f;  /* grÃ¼n */

  --cell:40px;
  --radius:14px;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
}

header{
  position:sticky; top:0; z-index:10;
  background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.15));
  backdrop-filter:blur(8px);
  border-bottom:1px solid var(--line);
}

.top{
  max-width:1100px;
  margin:auto;
  padding:12px;
}

h1{margin:0;font-size:20px}
.sub{font-size:13px;color:var(--muted);margin-top:6px}

main{
  max-width:1100px;
  margin:auto;
  padding:12px;
}

.card{
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:12px;
}

table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
}

th,td{
  text-align:center;
  padding:6px 4px;
  border-bottom:1px solid var(--line);
  font-size:13px;
}

th:first-child,td:first-child{
  text-align:left;
  width:140px;
}

.cell{
  width:var(--cell);
  height:var(--cell);
  border-radius:10px;
  border:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  user-select:none;
}

.cell.kaza{background:var(--kaza)}
.cell.farz{background:var(--farz)}
.cell.sunnet{background:var(--sunnet); color:#000}
.cell.cemaat{background:var(--cemaat)}

.controls{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

button,select{
  background:rgba(0,0,0,.2);
  color:var(--text);
  border:1px solid var(--line);
  border-radius:10px;
  padding:8px 10px;
}
button{cursor:pointer}
</style>
</head>
<body>
<header>
  <div class="top">
    <h1>Namastakip</h1>
    <div class="sub">
      Tippen = Status wechseln:
      â¬› Kaza â†’ ðŸ”´ Farz â†’ ðŸŸ¡ SÃ¼nnet+Wajib â†’ ðŸŸ¢ Cemaat
    </div>
  </div>
</header>

<main>
<div class="card">
  <div class="controls">
    <button id="btnToday">Heute</button>

    <select id="selYear"></select>
    <select id="selMonth"></select>

    <button id="btnClearMonth">Monat lÃ¶schen</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Datum</th>
        <th>Sabah</th>
        <th>Ã–ÄŸle</th>
        <th>Ä°kindi</th>
        <th>AkÅŸam</th>
        <th>YatsÄ±</th>
        <th>Vitir (Wajib)</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="sub" style="margin-top:10px">
    Hinweis: Alles speichert automatisch auf deinem Handy. FÃ¼r â€žewiges Archivâ€œ kommt im Backup-Bereich ein Speichern-Button.
  </div>
</div>

<!-- Rechte Box (ZÃ¤hler + Backup) kommt in Teil 3 -->
<div class="card" style="margin-top:12px">
  <h3 style="margin:0 0 8px 0; font-size:15px;">ZÃ¤hler & Backup</h3>
  <div class="sub">Kommt gleich in Teil 3 (Balken + Speichern + Export/Import).</div>
</div>

<script>
(() => {
  // ====== KONFIG ======
  const START_YEAR = 2002;
  const END_YEAR   = 2030;

  const PRAYERS = [
    { key:"sabah",  label:"Sabah" },
    { key:"ogle",   label:"Ã–ÄŸle" },
    { key:"ikindi", label:"Ä°kindi" },
    { key:"aksam",  label:"AkÅŸam" },
    { key:"yatsi",  label:"YatsÄ±" },
    { key:"vitir",  label:"Vitir" },
  ];

  // Status: 0 leer, 1 Kaza (schwarz), 2 Farz (rot), 3 SÃ¼nnet+Wajib (gelb), 4 Cemaat (grÃ¼n)
  const statusClass = (s) =>
    s===1 ? "kaza" : s===2 ? "farz" : s===3 ? "sunnet" : s===4 ? "cemaat" : "";

  const statusSymbol = (s) => s===0 ? "" : "âœ“";

  const DB_KEY = "namastakip_v4_db";
  let db = {};
  try{ db = JSON.parse(localStorage.getItem(DB_KEY) || "{}") || {}; }catch(e){ db = {}; }

  // ====== HELPERS ======
  const pad2 = (n) => String(n).padStart(2,"0");
  const iso = (y,m,d) => `${y}-${pad2(m)}-${pad2(d)}`;
  const daysInMonth = (y,m0) => new Date(y, m0+1, 0).getDate();
  const wd = (dateObj) => ["So","Mo","Di","Mi","Do","Fr","Sa"][dateObj.getDay()];
  const monthName = (m0) => ["Jan","Feb","MÃ¤r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"][m0];
  const fmtDE = (dateObj) => `${wd(dateObj)} ${pad2(dateObj.getDate())}.${pad2(dateObj.getMonth()+1)}.${dateObj.getFullYear()}`;

  function ensureDay(dateISO){
    if(!db[dateISO]){
      db[dateISO] = {};
      for(const p of PRAYERS) db[dateISO][p.key] = 0;
    } else {
      for(const p of PRAYERS){
        if(typeof db[dateISO][p.key] !== "number") db[dateISO][p.key] = 0;
      }
    }
    return db[dateISO];
  }

  function saveDB(){
    localStorage.setItem(DB_KEY, JSON.stringify(db));
  }

  // ====== UI ======
  const selYear = document.getElementById("selYear");
  const selMonth = document.getElementById("selMonth");
  const tbody = document.getElementById("tbody");
  const btnToday = document.getElementById("btnToday");
  const btnClearMonth = document.getElementById("btnClearMonth");

  function fillSelectors(){
    selYear.innerHTML = "";
    for(let y=END_YEAR; y>=START_YEAR; y--){
      const o = document.createElement("option");
      o.value = String(y);
      o.textContent = String(y);
      selYear.appendChild(o);
    }

    selMonth.innerHTML = "";
    for(let m0=0; m0<12; m0++){
      const o = document.createElement("option");
      o.value = String(m0);
      o.textContent = `${pad2(m0+1)} ${monthName(m0)}`;
      selMonth.appendChild(o);
    }
  }

  function renderMonth(){
    const year = parseInt(selYear.value,10);
    const m0 = parseInt(selMonth.value,10);
    const dim = daysInMonth(year,m0);

    const frag = document.createDocumentFragment();
    tbody.innerHTML = "";

    for(let d=1; d<=dim; d++){
      const dateObj = new Date(year,m0,d);
      const dateISO = iso(year,m0+1,d);
      const rec = ensureDay(dateISO);

      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.textContent = fmtDE(dateObj);
      tr.appendChild(tdDate);

      for(const p of PRAYERS){
        const td = document.createElement("td");
        const div = document.createElement("div");
        div.className = "cell " + statusClass(rec[p.key]||0);
        div.textContent = statusSymbol(rec[p.key]||0);

        div.addEventListener("click", () => {
          const day = ensureDay(dateISO);
          const cur = day[p.key] || 0;
          const next = (cur + 1) % 5; // 0->1->2->3->4->0
          day[p.key] = next;

          div.className = "cell " + statusClass(next);
          div.textContent = statusSymbol(next);

          saveDB();
          // ZÃ¤hler/Balken/Backup aktualisieren kommt in Teil 3
          if(typeof window.__namastakipUpdateAll === "function") window.__namastakipUpdateAll();
        });

        td.appendChild(div);
        tr.appendChild(td);
      }

      frag.appendChild(tr);
    }

    tbody.appendChild(frag);

    if(typeof window.__namastakipUpdateAll === "function") window.__namastakipUpdateAll();
  }

  btnToday.addEventListener("click", () => {
    const now = new Date();
    selYear.value = String(now.getFullYear());
    selMonth.value = String(now.getMonth());
    renderMonth();
  });

  btnClearMonth.addEventListener("click", () => {
    const ok = confirm("Diesen Monat wirklich lÃ¶schen?");
    if(!ok) return;

    const year = parseInt(selYear.value,10);
    const m0 = parseInt(selMonth.value,10);
    const dim = daysInMonth(year,m0);

    for(let d=1; d<=dim; d++){
      const key = iso(year,m0+1,d);
      if(db[key]) delete db[key];
    }
    saveDB();
    renderMonth();
  });

  selYear.addEventListener("change", renderMonth);
  selMonth.addEventListener("change", renderMonth);

  // ====== BOOT ======
  fillSelectors();
  const now = new Date();
  const y = Math.max(START_YEAR, Math.min(END_YEAR, now.getFullYear()));
  selYear.value = String(y);
  selMonth.value = String(now.getMonth());
  renderMonth();

  // Export fÃ¼r Teil 3
  window.__namastakipDB = {
    get(){ return db; },
    set(next){ db = next || {}; saveDB(); renderMonth(); },
    save: saveDB
  };
})();
</script>
<script>
(() => {
  <script>
(() => {
  // ====== Einstellungen ======
  const SETTINGS_KEY = "namastakip_v4_settings";
  const DB_KEY = "namastakip_v4_db";

  const obligationAge = 10;

  // FÃ¼r â€žvoller Tag erledigtâ€œ zÃ¤hlen NUR die 5 Pflichtgebete:
  const FIVE_KEYS = ["sabah","ogle","ikindi","aksam","yatsi"]; // vitir zÃ¤hlt NICHT fÃ¼r Tages-âœ“

  let settings = { birthDate: "1998-01-01" };
  try{
    const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "null");
    if(s && typeof s === "object") settings = { ...settings, ...s };
  }catch(e){}

  function saveSettings(){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  }

  // ====== Rechte Box neu aufbauen ======
  const cards = document.querySelectorAll("main .card");
  const rightCard = cards[cards.length - 1];

  rightCard.innerHTML = `
    <h3 style="margin:0 0 8px 0; font-size:15px;">Tracker & Jahreskalender</h3>

    <div class="sub" style="margin:0 0 10px 0;">
      â€žNamaz-Tag erledigtâ€œ = alle <b>5 Pflichtgebete</b> (Sabahâ€“YatsÄ±) erledigt. Vitir ist extra.
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
      <span class="pill">Geburt: <input id="birthDate" type="date" style="padding:6px 8px; border-radius:10px;" /></span>
      <button id="btnApplyBirth">Ãœbernehmen</button>
    </div>

    <div style="border:1px solid var(--line); border-radius:12px; padding:10px; background:rgba(0,0,0,.12);">
      <div class="sub" style="margin:0 0 8px 0;"><b>Deine erledigten Namaz-Tage (gesamt)</b></div>

      <div style="display:grid; gap:6px; font-size:13px;">
        <div style="display:flex; justify-content:space-between;">
          <span>Namaz-Tage erledigt</span><b id="doneDays">0</b>
        </div>
        <div style="display:flex; justify-content:space-between;">
          <span>Entspricht Monate (Ã·30)</span><b id="doneMonths">0.00</b>
        </div>
        <div style="display:flex; justify-content:space-between;">
          <span>Entspricht Jahre (Monate Ã·12)</span><b id="doneYears">0.00</b>
        </div>
      </div>
    </div>

    <div style="height:12px;"></div>

    <div style="border:1px solid var(--line); border-radius:12px; padding:10px; background:rgba(0,0,0,.12);">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div class="sub" style="margin:0;"><b>Jahreskalender âœ“ (5 Pflichtgebete erledigt)</b></div>
        <span class="pill">Jahr: <b id="calYearLabel">â€“</b></span>
      </div>

      <div class="sub" style="margin:8px 0 10px 0;">
        Jeder Tag mit âœ“ bedeutet: Sabahâ€“YatsÄ± erledigt.
      </div>

      <div id="yearCalendar" style="display:grid; gap:10px;"></div>
    </div>

    <div style="height:12px;"></div>

    <div style="border:1px solid var(--line); border-radius:12px; padding:10px; background:rgba(0,0,0,.12);">
      <div class="sub" style="margin:0 0 6px 0;"><b>Backup (ewiges Archiv)</b></div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="btnSaveFile">Backup speichern</button>
        <button id="btnLoadFile">Backup laden</button>
        <button id="btnExportText">Export (Text)</button>
        <button id="btnImportText">Import (Text)</button>
      </div>
      <textarea id="backupText" placeholder="Export-Text erscheint hierâ€¦ oder Import-Text einfÃ¼gen"></textarea>
      <div class="sub" style="margin-top:8px;">
        Empfehlung: Backup speichern â†’ Dateien â†’ iCloud Drive.
      </div>
    </div>

    <input id="filePicker" type="file" accept="application/json" style="display:none" />
  `;

  // ====== UI refs ======
  const birthDate = document.getElementById("birthDate");
  const btnApplyBirth = document.getElementById("btnApplyBirth");

  const doneDaysEl = document.getElementById("doneDays");
  const doneMonthsEl = document.getElementById("doneMonths");
  const doneYearsEl = document.getElementById("doneYears");

  const calYearLabel = document.getElementById("calYearLabel");
  const yearCalendar = document.getElementById("yearCalendar");

  const btnSaveFile = document.getElementById("btnSaveFile");
  const btnLoadFile = document.getElementById("btnLoadFile");
  const filePicker  = document.getElementById("filePicker");
  const btnExportText = document.getElementById("btnExportText");
  const btnImportText = document.getElementById("btnImportText");
  const backupText = document.getElementById("backupText");

  birthDate.value = settings.birthDate || "1998-01-01";
  btnApplyBirth.addEventListener("click", () => {
    if(!birthDate.value) return alert("Bitte Geburtsdatum auswÃ¤hlen.");
    settings.birthDate = birthDate.value;
    saveSettings();
    updateAll();
    alert("Gespeichert âœ…");
  });

  // ====== Helpers ======
  const pad2 = (n) => String(n).padStart(2,"0");
  const iso = (y,m,d) => `${y}-${pad2(m)}-${pad2(d)}`;
  const daysInMonth = (y,m0) => new Date(y, m0+1, 0).getDate();
  const monthNames = ["Jan","Feb","MÃ¤r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];
  const weekNames = ["Mo","Di","Mi","Do","Fr","Sa","So"];

  function obligationStart(){
    const [y,m,d] = (settings.birthDate || "1998-01-01").split("-").map(n=>parseInt(n,10));
    const start = new Date(y + obligationAge, (m-1), d);
    start.setHours(0,0,0,0);
    return start;
  }

  function isFullDay5(rec){
    // â€žvoller Tagâ€œ = alle 5 Pflichtgebete nicht leer
    for(const k of FIVE_KEYS){
      const v = rec?.[k] || 0;
      if(v === 0) return false;
    }
    return true;
  }

  // ====== Tracker + Kalender ======
  function updateAll(){
    const db = (window.__namastakipDB && window.__namastakipDB.get) ? window.__namastakipDB.get() : {};

    // 1) ZÃ¤hle volle Tage (5 Pflichtgebete) Ã¼ber ALLE gespeicherten EintrÃ¤ge
    let doneDays = 0;
    for(const dateISO in db){
      const rec = db[dateISO];
      if(rec && isFullDay5(rec)) doneDays++;
    }

    const months = doneDays / 30;
    const years = months / 12;

    doneDaysEl.textContent = String(doneDays);
    doneMonthsEl.textContent = months.toFixed(2);
    doneYearsEl.textContent = years.toFixed(2);

    // 2) Jahreskalender fÃ¼r aktuell ausgewÃ¤hltes Jahr (aus Dropdown links)
    const year = getSelectedYear();
    calYearLabel.textContent = String(year);
    renderYearCalendar(year, db);
  }

  function getSelectedYear(){
    // nutzt das Jahr-Dropdown aus Teil 2
    const selYear = document.getElementById("selYear");
    const y = parseInt(selYear?.value || "2026", 10);
    return isNaN(y) ? new Date().getFullYear() : y;
  }

  function renderYearCalendar(year, db){
    yearCalendar.innerHTML = "";

    // CSS fÃ¼r Kalender (inline, damit du nichts suchen musst)
    const styleId = "yearCalStyleV1";
    if(!document.getElementById(styleId)){
      const st = document.createElement("style");
      st.id = styleId;
      st.textContent = `
        .mBox{ border:1px solid var(--line); border-radius:12px; background:rgba(0,0,0,.10); padding:10px; }
        .mHead{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .mHead b{ color:var(--muted); font-size:13px; }
        .dow{ display:grid; grid-template-columns:repeat(7, 1fr); gap:4px; margin-bottom:6px; }
        .dow div{ font-size:11px; color:var(--muted); text-align:center; opacity:.9; }
        .grid{ display:grid; grid-template-columns:repeat(7, 1fr); gap:4px; }
        .d{
          height:22px; border-radius:6px; border:1px solid rgba(255,255,255,.14);
          display:flex; align-items:center; justify-content:center;
          font-size:11px; color:rgba(255,255,255,.75);
          background: rgba(0,0,0,.10);
        }
        .d.off{ opacity:.25; }
        .d.done{
          background: rgba(46,229,157,.22);
          border-color: rgba(46,229,157,.55);
          color: #eafff7;
          font-weight:700;
        }
      `;
      document.head.appendChild(st);
    }

    // 12 Monate
    for(let m0=0; m0<12; m0++){
      const box = document.createElement("div");
      box.className = "mBox";

      const head = document.createElement("div");
      head.className = "mHead";
      head.innerHTML = `<b>${monthNames[m0]}</b><span class="pill" style="padding:5px 8px;">${year}</span>`;
      box.appendChild(head);

      const dow = document.createElement("div");
      dow.className = "dow";
      for(const w of weekNames){
        const el = document.createElement("div");
        el.textContent = w;
        dow.appendChild(el);
      }
      box.appendChild(dow);

      const grid = document.createElement("div");
      grid.className = "grid";

      const first = new Date(year, m0, 1);
      // JS: So=0..Sa=6, wir wollen Mo=0..So=6
      const shift = (first.getDay() + 6) % 7;
      const dim = daysInMonth(year, m0);

      // leading empty cells
      for(let i=0; i<shift; i++){
        const c = document.createElement("div");
        c.className = "d off";
        c.textContent = "";
        grid.appendChild(c);
      }

      for(let d=1; d<=dim; d++){
        const dateISO = iso(year, m0+1, d);
        const rec = db[dateISO];
        const done = rec && isFullDay5(rec);

        const c = document.createElement("div");
        c.className = "d" + (done ? " done" : "");
        // âœ“ statt Zahl, damit man sofort sieht â€žerledigtâ€œ
        c.textContent = done ? "âœ“" : String(d);
        grid.appendChild(c);
      }

      box.appendChild(grid);
      yearCalendar.appendChild(box);
    }
  }

  // ====== Backup (Datei + Text) ======
  btnSaveFile.addEventListener("click", () => {
    const payload = {
      version: 4,
      savedAt: new Date().toISOString(),
      settings,
      db: (window.__namastakipDB && window.__namastakipDB.get) ? window.__namastakipDB.get() : {}
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
    const now = new Date();
    const stamp = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
    const filename = `namastakip-backup-${stamp}.json`;

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
  });

  btnLoadFile.addEventListener("click", () => {
    filePicker.value = "";
    filePicker.click();
  });

  filePicker.addEventListener("change", async () => {
    const f = filePicker.files && filePicker.files[0];
    if(!f) return;
    try{
      const txt = await f.text();
      const obj = JSON.parse(txt);
      if(!obj || typeof obj !== "object") throw new Error("ungÃ¼ltig");

      if(obj.settings) settings = { ...settings, ...obj.settings };
      if(obj.db && window.__namastakipDB && window.__namastakipDB.set){
        window.__namastakipDB.set(obj.db);
      } else if(obj.db){
        localStorage.setItem(DB_KEY, JSON.stringify(obj.db));
      }

      saveSettings();
      birthDate.value = settings.birthDate || "1998-01-01";
      updateAll();
      alert("Backup geladen âœ…");
    }catch(e){
      alert("Backup konnte nicht geladen werden (ungÃ¼ltige Datei).");
    }
  });

  btnExportText.addEventListener("click", () => {
    const payload = {
      version: 4,
      savedAt: new Date().toISOString(),
      settings,
      db: (window.__namastakipDB && window.__namastakipDB.get) ? window.__namastakipDB.get() : {}
    };
    backupText.value = JSON.stringify(payload);
    backupText.focus();
    backupText.select();
  });

  btnImportText.addEventListener("click", () => {
    const txt = (backupText.value || "").trim();
    if(!txt) return alert("Bitte zuerst Import-Text einfÃ¼gen.");
    try{
      const obj = JSON.parse(txt);
      if(!obj || typeof obj !== "object") throw new Error("ungÃ¼ltig");

      if(obj.settings) settings = { ...settings, ...obj.settings };
      if(obj.db && window.__namastakipDB && window.__namastakipDB.set){
        window.__namastakipDB.set(obj.db);
      }

      saveSettings();
      birthDate.value = settings.birthDate || "1998-01-01";
      updateAll();
      alert("Import abgeschlossen âœ…");
    }catch(e){
      alert("Import fehlgeschlagen: ungÃ¼ltiger Text.");
    }
  });

  // ====== Verbindung zu Teil 2 (nach jedem Klick aktualisieren) ======
  window.__namastakipUpdateAll = updateAll;

  // Wenn Jahr/Monat geÃ¤ndert wird, Jahreskalender updaten
  const selYear = document.getElementById("selYear");
  if(selYear) selYear.addEventListener("change", updateAll);

  // Start
  updateAll();

})();
</script>

</main>
</body>
</html>
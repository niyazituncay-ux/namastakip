<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Namastakip</title>

<style>
:root{
  --bg1:#35d0d6;
  --bg2:#0aa0a8;
  --panel:rgba(8,20,24,.78);
  --panel2:rgba(8,20,24,.62);
  --text:#ecfbff;
  --muted:#c9f3f7;
  --line:rgba(255,255,255,.18);

  --kaza:#0f0f10;      /* schwarz */
  --farz:#ff5a5a;      /* rot */
  --sunnet:#ffd84d;    /* gelb */
  --cemaat:#35e38f;    /* grÃ¼n */

  --radius:14px;
  --cell:34px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:
    radial-gradient(900px 600px at 10% 0%, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 55%),
    linear-gradient(180deg,var(--bg1),var(--bg2));
  min-height:100vh;
}
header{
  position:sticky; top:0; z-index:20;
  background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.12));
  backdrop-filter:blur(10px);
  border-bottom:1px solid var(--line);
}
.top{
  max-width:1100px;
  margin:0 auto;
  padding:12px 12px;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}
h1{margin:0;font-size:20px}
.sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}
.controls{
  display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
}
button, select, input{
  background:rgba(0,0,0,.18);
  color:var(--text);
  border:1px solid var(--line);
  border-radius:12px;
  padding:9px 11px;
  font-size:14px;
  outline:none;
}
button{cursor:pointer}
button:active{transform:translateY(1px)}
.btnDanger{border-color:rgba(255,90,106,.55)}
.pill{
  display:inline-flex; gap:8px; align-items:center;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.12);
  color:var(--muted);
  font-size:12px;
  white-space:nowrap;
}

main{
  max-width:1100px;
  margin:0 auto;
  padding:12px 12px 40px;
  display:grid;
  grid-template-columns: 1.6fr 1fr;
  gap:12px;
}
@media (max-width:980px){
  main{grid-template-columns:1fr}
  .controls{justify-content:flex-start}
}
.card{
  border:1px solid var(--line);
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  border-radius:var(--radius);
  padding:12px;
  overflow:hidden;
}

/* Tabelle stabil (keine verrutschten Ãœberschriften) */
table{width:100%; border-collapse:collapse; table-layout:fixed}
th,td{
  border-bottom:1px solid var(--line);
  padding:6px 4px;
  text-align:center;
  font-size:12px;
}
thead th{
  position:sticky;
  top:86px;
  background:rgba(0,0,0,.18);
  backdrop-filter:blur(8px);
  z-index:10;
}
th:first-child, td:first-child{
  text-align:left;
  width:92px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  font-size:12px;
  color:var(--muted);
}

.cell{
  width:var(--cell);
  height:var(--cell);
  border-radius:10px;
  border:1px solid rgba(255,255,255,.20);
  background:rgba(0,0,0,.10);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  user-select:none;
  cursor:pointer;
  font-weight:900;
  line-height:1;
}
.cell.kaza{background:var(--kaza)}
.cell.farz{background:var(--farz)}
.cell.sunnet{background:var(--sunnet); color:#101010}
.cell.cemaat{background:var(--cemaat); color:#0b1b12}

textarea{
  width:100%;
  min-height:120px;
  resize:vertical;
  margin-top:10px;
  background:rgba(0,0,0,.16);
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  color:var(--text);
  font-size:12px;
  outline:none;
}

/* Jahreskalender */
.yearGrid{display:grid; gap:10px}
.mBox{
  border:1px solid var(--line);
  border-radius:12px;
  background:rgba(0,0,0,.10);
  padding:10px;
}
.mHead{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
.dow{display:grid; grid-template-columns:repeat(7,1fr); gap:4px; margin-bottom:6px}
.dow div{font-size:10px; color:var(--muted); text-align:center; opacity:.9}
.grid{display:grid; grid-template-columns:repeat(7,1fr); gap:4px}
.d{
  height:22px;
  border-radius:6px;
  border:1px solid rgba(255,255,255,.14);
  display:flex; align-items:center; justify-content:center;
  font-size:11px;
  color:rgba(255,255,255,.78);
  background:rgba(0,0,0,.10);
}
.d.off{opacity:.25}
.d.done{
  background:rgba(46,229,157,.22);
  border-color:rgba(46,229,157,.55);
  color:#eafff7;
  font-weight:900;
}
.smallRow{
  display:flex; justify-content:space-between; gap:10px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.10);
  padding:8px 10px;
  border-radius:12px;
  font-size:13px;
  margin-top:8px;
}
</style>
</head>

<body>
<header>
  <div class="top">
    <div>
      <h1>Namastakip</h1>
      <div class="sub">
        Tippen = Status wechseln: â¬› Kaza â†’ ðŸ”´ Farz â†’ ðŸŸ¡ SÃ¼nnet+Wajib â†’ ðŸŸ¢ Cemaat â†’ leer
      </div>
    </div>

    <div class="controls">
      <button id="btnToday">Heute</button>
      <span class="pill">Jahr: <select id="selYear"></select></span>
      <span class="pill">Monat: <select id="selMonth"></select></span>
      <button id="btnClearMonth" class="btnDanger">Monat lÃ¶schen</button>
    </div>
  </div>
</header>

<main>
  <!-- LINKS: Tabelle -->
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>Sabah</th>
          <th>Ã–ÄŸle</th>
          <th>Ä°kindi</th>
          <th>AkÅŸam</th>
          <th>YatsÄ±</th>
          <th>Vitir</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="sub" style="margin-top:10px">
      Autospeichern ist aktiv. FÃ¼r â€žewiges Archivâ€œ nutze rechts <b>Backup speichern</b>.
    </div>
  </div>

  <!-- RECHTS -->
  <div class="card" id="rightCard"></div>
</main>

<script>
(() => {
  const START_YEAR = 2002;
  const END_YEAR = 2030;

  // 0 leer, 1 Kaza, 2 Farz, 3 SÃ¼nnet+Wajib, 4 Cemaat
  const PRAYERS = ["sabah","ogle","ikindi","aksam","yatsi","vitir"];
  const FIVE_KEYS = ["sabah","ogle","ikindi","aksam","yatsi"]; // Namaz-Tag = diese 5
  const DB_KEY = "namastakip_final_db_v1";

  let db = {};
  try { db = JSON.parse(localStorage.getItem(DB_KEY) || "{}") || {}; } catch(e){ db = {}; }

  const pad2 = (n)=>String(n).padStart(2,"0");
  const iso = (y,m,d)=>`${y}-${pad2(m)}-${pad2(d)}`;
  const daysInMonth = (y,m0)=>new Date(y,m0+1,0).getDate();
  const wd = (d)=>["So","Mo","Di","Mi","Do","Fr","Sa"][d.getDay()];
  const fmtShort = (d)=>`${wd(d)} ${pad2(d.getDate())}.${pad2(d.getMonth()+1)}`;
  const monthName = (m0)=>["Jan","Feb","MÃ¤r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"][m0];
  const monthNames = ["Jan","Feb","MÃ¤r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];
  const weekNames = ["Mo","Di","Mi","Do","Fr","Sa","So"];

  function ensureDay(dateISO){
    if(!db[dateISO]){
      db[dateISO] = {};
      for(const k of PRAYERS) db[dateISO][k]=0;
    }else{
      for(const k of PRAYERS) if(typeof db[dateISO][k] !== "number") db[dateISO][k]=0;
    }
    return db[dateISO];
  }
  function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

  function statusClass(s){
    return s===1 ? "kaza" : s===2 ? "farz" : s===3 ? "sunnet" : s===4 ? "cemaat" : "";
  }
  function symbol(s){ return s===0 ? "" : "âœ“"; }

  // DOM
  const selYear = document.getElementById("selYear");
  const selMonth = document.getElementById("selMonth");
  const tbody = document.getElementById("tbody");
  const btnToday = document.getElementById("btnToday");
  const btnClearMonth = document.getElementById("btnClearMonth");
  const rightCard = document.getElementById("rightCard");

  function fillSelectors(){
    selYear.innerHTML = "";
    for(let y=END_YEAR; y>=START_YEAR; y--){
      const o=document.createElement("option");
      o.value=String(y); o.textContent=String(y);
      selYear.appendChild(o);
    }
    selMonth.innerHTML = "";
    for(let m0=0; m0<12; m0++){
      const o=document.createElement("option");
      o.value=String(m0);
      o.textContent=`${pad2(m0+1)} ${monthName(m0)}`;
      selMonth.appendChild(o);
    }
  }

  function renderMonth(){
    const year = parseInt(selYear.value,10);
    const m0 = parseInt(selMonth.value,10);
    const dim = daysInMonth(year,m0);

    tbody.innerHTML = "";
    const frag = document.createDocumentFragment();

    for(let d=1; d<=dim; d++){
      const dateObj = new Date(year,m0,d);
      const dateISO = iso(year,m0+1,d);
      const rec = ensureDay(dateISO);

      const tr=document.createElement("tr");

      const tdDate=document.createElement("td");
      tdDate.textContent = fmtShort(dateObj);
      tr.appendChild(tdDate);

      for(const k of PRAYERS){
        const td=document.createElement("td");
        const div=document.createElement("div");
        div.className = "cell " + statusClass(rec[k]||0);
        div.textContent = symbol(rec[k]||0);

        div.addEventListener("click", ()=>{
          const day = ensureDay(dateISO);
          const cur = day[k] || 0;
          const next = (cur + 1) % 5; // 0->1->2->3->4->0
          day[k] = next;

          div.className = "cell " + statusClass(next);
          div.textContent = symbol(next);

          saveDB();
          updateRight();
        });

        td.appendChild(div);
        tr.appendChild(td);
      }

      frag.appendChild(tr);
    }

    tbody.appendChild(frag);
    updateRight();
  }

  // Tracker: ganzer Tag
  function isFullDay5(rec){
    for(const k of FIVE_KEYS){
      if((rec?.[k] || 0) === 0) return false;
    }
    return true;
  }

  function updateRight(){
    const year = parseInt(selYear.value,10);

    // Tracker: gesamte erledigte Namaz-Tage (alle gespeicherten Daten)
    let doneDays = 0;
    for(const dateISO in db){
      if(isFullDay5(db[dateISO])) doneDays++;
    }
    const months = doneDays / 30;
    const years = months / 12;

    rightCard.innerHTML = `
      <h3 style="margin:0 0 8px 0; font-size:15px;">Tracker (ganze Tage) & Jahreskalender</h3>

      <div class="sub" style="margin:0 0 10px 0;">
        â€žNamaz-Tagâ€œ = <b>Sabahâ€“YatsÄ±</b> erledigt (Farben egal). Vitir ist extra.
      </div>

      <div class="smallRow"><span>Namaz-Tage erledigt</span><b>${doneDays}</b></div>
      <div class="smallRow"><span>Entspricht Monate (Ã·30)</span><b>${months.toFixed(2)}</b></div>
      <div class="smallRow"><span>Entspricht Jahre (Ã·12)</span><b>${years.toFixed(2)}</b></div>

      <div style="height:12px;"></div>

      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div class="sub" style="margin:0;"><b>Jahreskalender âœ“</b> (Sabahâ€“YatsÄ± erledigt)</div>
        <span class="pill">Jahr: <b>${year}</b></span>
      </div>

      <div class="yearGrid" id="yearCalendar" style="margin-top:10px;"></div>

      <div style="height:12px;"></div>

      <div class="sub"><b>Backup (ewiges Archiv)</b></div>
      <div class="sub" style="margin-top:6px;">
        Speichere die Backup-Datei in <b>Dateien â†’ iCloud Drive</b> (fÃ¼r neues Handy).
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
        <button id="btnSaveFile">Backup speichern</button>
        <button id="btnLoadFile">Backup laden</button>
        <button id="btnExportText">Export (Text)</button>
        <button id="btnImportText">Import (Text)</button>
      </div>

      <textarea id="backupText" placeholder="Export-Text erscheint hierâ€¦ oder Import-Text einfÃ¼gen"></textarea>
      <input id="filePicker" type="file" accept="application/json" style="display:none" />
    `;

    // Render year calendar
    renderYearCalendar(year);

    // Hook buttons
    const btnSaveFile = document.getElementById("btnSaveFile");
    const btnLoadFile = document.getElementById("btnLoadFile");
    const btnExportText = document.getElementById("btnExportText");
    const btnImportText = document.getElementById("btnImportText");
    const backupText = document.getElementById("backupText");
    const filePicker = document.getElementById("filePicker");

    btnSaveFile.addEventListener("click", ()=>{
      const payload = { version: "final-v1", savedAt: new Date().toISOString(), db };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const now = new Date();
      const stamp = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
      const filename = `namastakip-backup-${stamp}.json`;

      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download=filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href),1200);
    });

    btnLoadFile.addEventListener("click", ()=>{
      filePicker.value="";
      filePicker.click();
    });

    filePicker.addEventListener("change", async ()=>{
      const f = filePicker.files && filePicker.files[0];
      if(!f) return;
      try{
        const txt = await f.text();
        const obj = JSON.parse(txt);
        if(!obj || typeof obj !== "object" || !obj.db) throw new Error("invalid");
        db = obj.db;
        saveDB();
        renderMonth(); // will call updateRight
        alert("Backup geladen âœ…");
      }catch(e){
        alert("Backup konnte nicht geladen werden (ungÃ¼ltige Datei).");
      }
    });

    btnExportText.addEventListener("click", ()=>{
      const payload = { version:"final-v1", savedAt:new Date().toISOString(), db };
      backupText.value = JSON.stringify(payload);
      backupText.focus();
      backupText.select();
    });

    btnImportText.addEventListener("click", ()=>{
      const txt = (backupText.value||"").trim();
      if(!txt) return alert("Bitte Import-Text einfÃ¼gen.");
      try{
        const obj = JSON.parse(txt);
        if(!obj || typeof obj !== "object" || !obj.db) throw new Error("invalid");
        db = obj.db;
        saveDB();
        renderMonth();
        alert("Import abgeschlossen âœ…");
      }catch(e){
        alert("Import fehlgeschlagen (Text ungÃ¼ltig).");
      }
    });

    function renderYearCalendar(y){
      const cal = document.getElementById("yearCalendar");
      cal.innerHTML = "";

      for(let m0=0; m0<12; m0++){
        const box = document.createElement("div");
        box.className = "mBox";

        const head = document.createElement("div");
        head.className = "mHead";
        head.innerHTML = `<b style="color:var(--muted); font-size:13px;">${monthNames[m0]}</b><span class="pill" style="padding:5px 8px;">${y}</span>`;
        box.appendChild(head);

        const dow = document.createElement("div");
        dow.className = "dow";
        for(const w of weekNames){
          const el = document.createElement("div");
          el.textContent = w;
          dow.appendChild(el);
        }
        box.appendChild(dow);

        const grid = document.createElement("div");
        grid.className = "grid";

        const first = new Date(y, m0, 1);
        const shift = (first.getDay() + 6) % 7; // Mo=0
        const dim = daysInMonth(y,m0);

        for(let i=0; i<shift; i++){
          const c=document.createElement("div");
          c.className="d off";
          grid.appendChild(c);
        }

        for(let d=1; d<=dim; d++){
          const dateISO = iso(y, m0+1, d);
          const rec = db[dateISO];
          const done = rec && isFullDay5(rec);

          const c=document.createElement("div");
          c.className = "d" + (done ? " done" : "");
          c.textContent = done ? "âœ“" : String(d);
          grid.appendChild(c);
        }

        box.appendChild(grid);
        cal.appendChild(box);
      }
    }
  }

  // Controls
  btnToday.addEventListener("click", ()=>{
    const now = new Date();
    selYear.value = String(Math.max(START_YEAR, Math.min(END_YEAR, now.getFullYear())));
    selMonth.value = String(now.getMonth());
    renderMonth();
  });

  btnClearMonth.addEventListener("click", ()=>{
    const ok = confirm("Diesen Monat wirklich lÃ¶schen?");
    if(!ok) return;

    const year = parseInt(selYear.value,10);
    const m0 = parseInt(selMonth.value,10);
    const dim = daysInMonth(year,m0);

    for(let d=1; d<=dim; d++){
      const key = iso(year,m0+1,d);
      if(db[key]) delete db[key];
    }
    saveDB();
    renderMonth();
  });

  selYear.addEventListener("change", renderMonth);
  selMonth.addEventListener("change", renderMonth);

  // Boot
  fillSelectors();
  const now = new Date();
  selYear.value = String(Math.max(START_YEAR, Math.min(END_YEAR, now.getFullYear())));
  selMonth.value = String(now.getMonth());
  renderMonth();
})();
</script>
</body>
</html>
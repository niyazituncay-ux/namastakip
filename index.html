<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Namastakip</title>

<style>
:root{
  --bg1:#35d0d6;
  --bg2:#0aa0a8;
  --panel: rgba(6,18,22,.78);
  --panel2: rgba(6,18,22,.60);
  --line: rgba(255,255,255,.18);
  --text:#ecfbff;
  --muted:#c9f3f7;
  --ok:#2ee59d;
  --ok2:#1fbf83;
  --radius:14px;
  --cell:34px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:
    radial-gradient(900px 600px at 10% 0%, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 55%),
    linear-gradient(180deg,var(--bg1),var(--bg2));
}

/* Header */
header{
  position: sticky; top: 0; z-index: 50;
  background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.10));
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--line);
}
.top{
  max-width: 1200px;
  margin: 0 auto;
  padding: 12px;
  display:flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 12px;
  flex-wrap: wrap;
}
h1{margin:0;font-size:20px}
.sub{
  margin-top:6px;
  color: var(--muted);
  font-size: 13px;
  line-height: 1.35;
}
.controls{
  display:flex;
  gap:8px;
  flex-wrap: wrap;
  align-items: center;
  justify-content: flex-end;
}
button, select, input{
  background: rgba(0,0,0,.18);
  color: var(--text);
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 9px 11px;
  font-size: 14px;
  outline: none;
}
button{cursor:pointer}
button:active{transform: translateY(1px)}
.btnDanger{border-color: rgba(255,90,106,.55)}
.pill{
  display:inline-flex;
  gap:8px;
  align-items:center;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: rgba(0,0,0,.12);
  color: var(--muted);
  font-size: 12px;
  white-space: nowrap;
}

/* Layout */
main{
  max-width: 1200px;
  margin: 0 auto;
  padding: 12px 12px 40px;
  display:grid;
  grid-template-columns: 1.6fr 1fr;
  gap: 12px;
}
@media (max-width: 980px){
  main{grid-template-columns:1fr}
  .controls{justify-content:flex-start}
}

.card{
  border: 1px solid var(--line);
  background: linear-gradient(180deg, var(--panel), var(--panel2));
  border-radius: var(--radius);
  padding: 12px;
  overflow: hidden;
}

/* Table scroll container */
.tableWrap{
  max-height: 62vh;
  overflow: auto;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.10);
}

table{
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}
thead th{
  position: sticky;
  top: 0;
  z-index: 10;
  background: rgba(0,0,0,.28);
  backdrop-filter: blur(8px);
  border-bottom: 1px solid var(--line);
}
th, td{
  border-bottom: 1px solid var(--line);
  padding: 8px 4px;
  text-align: center;
  font-size: 12px;
}
th:first-child, td:first-child{
  text-align:left;
  width: 92px;
  padding-left: 8px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--muted);
}

/* Cells */
.cell{
  width: var(--cell);
  height: var(--cell);
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,.20);
  background: rgba(0,0,0,.10);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  user-select: none;
  cursor: pointer;
  font-weight: 900;
}
.cell.ok{
  background: linear-gradient(180deg, var(--ok), var(--ok2));
  color: #053225;
  border-color: rgba(255,255,255,.35);
  box-shadow: 0 8px 22px rgba(46,229,157,.20);
}

/* Right panel */
h3{margin:0 0 8px 0; font-size:15px}
.help{
  color: var(--muted);
  font-size: 12px;
  line-height: 1.35;
}
.smallBox{
  border: 1px solid var(--line);
  background: rgba(0,0,0,.10);
  border-radius: 12px;
  padding: 10px;
  margin-top: 10px;
}
.row{
  display:flex; gap:8px; flex-wrap:wrap; align-items:center;
}
.row > *{flex:1}
.kpi{
  display:flex; justify-content:space-between; gap:10px;
  padding: 8px 10px;
  border-radius: 12px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.10);
  font-size: 13px;
  margin-top: 8px;
}
textarea{
  width:100%;
  min-height: 120px;
  resize: vertical;
  margin-top: 10px;
  background: rgba(0,0,0,.16);
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 10px;
  color: var(--text);
  font-size: 12px;
  outline: none;
}

/* Year view */
.yearGrid{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 10px;
}
@media (min-width: 980px){
  .yearGrid{grid-template-columns: repeat(3, 1fr);}
}
.mini{
  border:1px solid var(--line);
  background: rgba(0,0,0,.10);
  border-radius: 12px;
  padding: 8px;
}
.miniTitle{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
}
.miniDays{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}
.miniDot{
  height: 12px;
  border-radius: 4px;
  border: 1px solid rgba(255,255,255,.15);
  background: rgba(0,0,0,.10);
}
.miniDot.on{
  background: linear-gradient(180deg, var(--ok), var(--ok2));
  border-color: rgba(255,255,255,.30);
}
.miniW{
  font-size:10px;
  color: rgba(255,255,255,.55);
  text-align:center;
  padding-bottom: 3px;
}
</style>
</head>

<body>
<header>
  <div class="top">
    <div>
      <h1>Namastakip</h1>
      <div class="sub">Tippen = ✅ grün an/aus (wenn gebetet → grün). Kopfzeile bleibt oben fest.</div>
    </div>
    <div class="controls">
      <button id="btnToday">Heute</button>
      <span class="pill">Jahr: <select id="selYear"></select></span>
      <span class="pill">Monat: <select id="selMonth"></select></span>
      <button id="btnClearMonth" class="btnDanger">Monat löschen</button>
    </div>
  </div>
</header>

<main>
  <div class="card">
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Datum</th>
            <th>Sabah</th>
            <th>Öğle</th>
            <th>İkindi</th>
            <th>Akşam</th>
            <th>Yatsı</th>
            <th>Vitir</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="sub" style="margin-top:10px">
      Autospeichern ist aktiv. Rechts kannst du Backup speichern/laden.
    </div>
  </div>

  <div class="card" id="rightCard"></div>
</main>
<script>
(() => {
  const START_YEAR = 2002;
  const END_YEAR = 2030;

  const PRAYERS = ["sabah","ogle","ikindi","aksam","yatsi","vitir"];
  // WICHTIG: Ein fester Key, damit Tracker + Tabelle immer dieselben Daten lesen
  const DB_KEY = "namastakip_green_single_v3";

  let db = {};
  try { db = JSON.parse(localStorage.getItem(DB_KEY) || "{}") || {}; } catch(e){ db = {}; }

  const pad2 = (n)=>String(n).padStart(2,"0");
  const iso = (y,m,d)=>`${y}-${pad2(m)}-${pad2(d)}`;
  const daysInMonth = (y,m0)=>new Date(y,m0+1,0).getDate();
  const wd = (d)=>["So","Mo","Di","Mi","Do","Fr","Sa"][d.getDay()];
  const fmtShort = (d)=>`${wd(d)} ${pad2(d.getDate())}.${pad2(d.getMonth()+1)}`;
  const monthNames = ["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];
  const weekShort = ["Mo","Di","Mi","Do","Fr","Sa","So"];

  function ensureDay(dateISO){
    if(!db[dateISO]){
      db[dateISO] = {};
      for(const k of PRAYERS) db[dateISO][k] = 0;
    }else{
      for(const k of PRAYERS) if(typeof db[dateISO][k] !== "number") db[dateISO][k] = 0;
    }
    return db[dateISO];
  }
  function saveDB(){
    localStorage.setItem(DB_KEY, JSON.stringify(db));
  }

  function isFullDay(rec){
    // “Tag erledigt” = alle 6 inkl. Vitir sind grün
    for(const k of PRAYERS){
      if((rec?.[k]||0) !== 1) return false;
    }
    return true;
  }

  function calcFullDays(){
    let done = 0;
    for(const dateISO in db){
      if(isFullDay(db[dateISO])) done++;
    }
    return done;
  }

  // DOM
  const selYear = document.getElementById("selYear");
  const selMonth = document.getElementById("selMonth");
  const tbody = document.getElementById("tbody");
  const btnToday = document.getElementById("btnToday");
  const btnClearMonth = document.getElementById("btnClearMonth");
  const rightCard = document.getElementById("rightCard");

  function fillSelectors(){
    selYear.innerHTML = "";
    for(let y=END_YEAR; y>=START_YEAR; y--){
      const o=document.createElement("option");
      o.value=String(y); o.textContent=String(y);
      selYear.appendChild(o);
    }
    selMonth.innerHTML = "";
    for(let m0=0; m0<12; m0++){
      const o=document.createElement("option");
      o.value=String(m0);
      o.textContent=`${pad2(m0+1)} ${monthNames[m0]}`;
      selMonth.appendChild(o);
    }
  }

  function renderMonth(){
    const year = parseInt(selYear.value,10);
    const m0 = parseInt(selMonth.value,10);
    const dim = daysInMonth(year,m0);

    tbody.innerHTML = "";
    const frag = document.createDocumentFragment();

    for(let d=1; d<=dim; d++){
      const dateObj = new Date(year,m0,d);
      const dateISO = iso(year,m0+1,d);
      const rec = ensureDay(dateISO);

      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.textContent = fmtShort(dateObj);
      tr.appendChild(tdDate);

      for(const k of PRAYERS){
        const td = document.createElement("td");
        const div = document.createElement("div");

        const v = rec[k] || 0;
        div.className = "cell" + (v===1 ? " ok" : "");
        div.textContent = v===1 ? "✓" : "";

        div.addEventListener("click", ()=>{
          const day = ensureDay(dateISO);
          day[k] = (day[k]===1 ? 0 : 1);
          div.className = "cell" + (day[k]===1 ? " ok" : "");
          div.textContent = day[k]===1 ? "✓" : "";
          saveDB();
          updateRight(); // Tracker neu aus DB berechnen (kann nicht nullen)
        });

        td.appendChild(div);
        tr.appendChild(td);
      }

      frag.appendChild(tr);
    }

    tbody.appendChild(frag);
    updateRight();
  }

  function parseISODate(s){
    if(!/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
    const [y,m,d] = s.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    if(dt.getFullYear()!==y || dt.getMonth()!==m-1 || dt.getDate()!==d) return null;
    return dt;
  }

  function setRange(startISO, endISO, value){
    const a = parseISODate(startISO);
    const b = parseISODate(endISO);
    if(!a || !b) return { ok:false, msg:"Bitte beide Daten korrekt auswählen." };
    if(a > b) return { ok:false, msg:"Startdatum muss vor Enddatum liegen." };

    const cur = new Date(a);
    let touched = 0;

    while(cur <= b){
      const y = cur.getFullYear();
      if(y >= START_YEAR && y <= END_YEAR){
        const key = iso(cur.getFullYear(), cur.getMonth()+1, cur.getDate());
        const rec = ensureDay(key);
        for(const k of PRAYERS) rec[k] = value;
        touched++;
      }
      cur.setDate(cur.getDate()+1);
    }

    saveDB();
    renderMonth();
    return { ok:true, msg:`Bereich aktualisiert: ${touched} Tage.` };
  }

  function buildMiniMonth(year, m0){
    const dim = daysInMonth(year,m0);
    const first = new Date(year,m0,1);

    // Wir starten mit Montag als erster Spalte:
    // JS: 0=So..6=Sa -> umrechnen auf 0=Mo..6=So
    const jsDay = first.getDay(); // 0..6
    const offset = (jsDay === 0) ? 6 : (jsDay - 1);

    const dots = [];
    // Wochentagsleiste
    for(const w of weekShort){
      dots.push(`<div class="miniW">${w}</div>`);
    }
    // Leere Felder vor dem 1.
    for(let i=0; i<offset; i++){
      dots.push(`<div class="miniDot" style="visibility:hidden"></div>`);
    }
    // Tage
    for(let d=1; d<=dim; d++){
      const key = iso(year, m0+1, d);
      const on = isFullDay(db[key]);
      dots.push(`<div class="miniDot ${on ? "on":""}" title="${key}"></div>`);
    }

    return `
      <div class="mini" data-m0="${m0}">
        <div class="miniTitle">
          <b>${monthNames[m0]}</b>
          <span style="opacity:.8">${year}</span>
        </div>
        <div class="miniDays">${dots.join("")}</div>
      </div>
    `;
  }

  function updateRight(){
    // Tracker immer aus db berechnen -> bleibt nach Refresh korrekt
    const doneDays = calcFullDays();
    const months = doneDays/30;
    const years = months/12;

    const year = parseInt(selYear.value,10);

    rightCard.innerHTML = `
      <h3>Tracker + Bereich + Jahresübersicht</h3>
      <div class="help">
        <b>Tracker</b> zählt <u>vollständige Tage</u>: alle 6 Felder (inkl. Vitir) grün.
        <br>Diese Zahlen kommen immer direkt aus deinem gespeicherten Archiv (localStorage).
      </div>

      <div class="kpi"><span>Vollständige Tage</span><b>${doneDays}</b></div>
      <div class="kpi"><span>≈ Monate (÷30)</span><b>${months.toFixed(2)}</b></div>
      <div class="kpi"><span>≈ Jahre (÷12)</span><b>${years.toFixed(2)}</b></div>

      <div class="smallBox">
        <div class="help"><b>Bereich abhaken</b> (setzt alle 6 Felder grün)</div>
        <div class="row" style="margin-top:8px">
          <div>
            <div class="help">Von</div>
            <input id="rangeFrom" type="date">
          </div>
          <div>
            <div class="help">Bis</div>
            <input id="rangeTo" type="date">
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="btnRangeCheck">Alles abhaken ✅</button>
          <button id="btnRangeClear" class="btnDanger">Alles leeren</button>
        </div>
        <div class="help" id="rangeMsg" style="margin-top:8px; opacity:.95;"></div>
      </div>

      <div class="smallBox">
        <div class="help"><b>Jahresübersicht</b> – grün = Tag komplett erledigt. Tippe auf einen Monat → springt dahin.</div>
        <div class="yearGrid">
          ${Array.from({length:12},(_,m0)=>buildMiniMonth(year,m0)).join("")}
        </div>
      </div>

      <div class="smallBox">
        <div class="help"><b>Backup</b> (für neues Handy)</div>
        <div class="row" style="margin-top:8px">
          <button id="btnSaveFile">Backup speichern (Datei)</button>
          <button id="btnLoadFile">Backup laden (Datei)</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnExportText">Export (Text)</button>
          <button id="btnImportText">Import (Text)</button>
        </div>
        <textarea id="backupText" placeholder="Export-Text erscheint hier… oder Import-Text einfügen"></textarea>
        <input id="filePicker" type="file" accept="application/json" style="display:none" />
      </div>
    `;

    // Range hooks (Default: aktueller Monat)
    const y = parseInt(selYear.value,10);
    const m0 = parseInt(selMonth.value,10);
    const dim = daysInMonth(y,m0);

    const from = document.getElementById("rangeFrom");
    const to = document.getElementById("rangeTo");
    from.value = `${y}-${pad2(m0+1)}-01`;
    to.value   = `${y}-${pad2(m0+1)}-${pad2(dim)}`;

    const msg = document.getElementById("rangeMsg");
    document.getElementById("btnRangeCheck").addEventListener("click", ()=>{
      const res = setRange(from.value, to.value, 1);
      msg.textContent = res.msg;
    });
    document.getElementById("btnRangeClear").addEventListener("click", ()=>{
      const ok = confirm("Wirklich diesen Bereich leeren?");
      if(!ok) return;
      const res = setRange(from.value, to.value, 0);
      msg.textContent = res.msg;
    });

    // Jahresübersicht: Klick auf Monat -> springen
    document.querySelectorAll(".mini").forEach(el=>{
      el.addEventListener("click", ()=>{
        const m = parseInt(el.getAttribute("data-m0"),10);
        selMonth.value = String(m);
        renderMonth();
        window.scrollTo({top:0, behavior:"smooth"});
      });
    });

    // Backup hooks
    const btnSaveFile = document.getElementById("btnSaveFile");
    const btnLoadFile = document.getElementById("btnLoadFile");
    const btnExportText = document.getElementById("btnExportText");
    const btnImportText = document.getElementById("btnImportText");
    const backupText = document.getElementById("backupText");
    const filePicker = document.getElementById("filePicker");

    btnSaveFile.addEventListener("click", ()=>{
      const payload = { version:"green-v3", savedAt: new Date().toISOString(), db };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const now = new Date();
      const stamp = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
      const filename = `namastakip-backup-${stamp}.json`;

      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download=filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href),1200);
    });

    btnLoadFile.addEventListener("click", ()=>{
      filePicker.value="";
      filePicker.click();
    });

    filePicker.addEventListener("change", async ()=>{
      const f = filePicker.files && filePicker.files[0];
      if(!f) return;
      try{
        const txt = await f.text();
        const obj = JSON.parse(txt);
        if(!obj || typeof obj !== "object" || !obj.db) throw new Error("invalid");
        db = obj.db;
        saveDB();
        renderMonth();
        alert("Backup geladen ✅");
      }catch(e){
        alert("Backup konnte nicht geladen werden (ungültige Datei).");
      }
    });

    btnExportText.addEventListener("click", ()=>{
      const payload = { version:"green-v3", savedAt:new Date().toISOString(), db };
      backupText.value = JSON.stringify(payload);
      backupText.focus();
      backupText.select();
    });

    btnImportText.addEventListener("click", ()=>{
      const txt = (backupText.value||"").trim();
      if(!txt) return alert("Bitte Import-Text einfügen.");
      try{
        const obj = JSON.parse(txt);
        if(!obj || typeof obj !== "object" || !obj.db) throw new Error("invalid");
        db = obj.db;
        saveDB();
        renderMonth();
        alert("Import abgeschlossen ✅");
      }catch(e){
        alert("Import fehlgeschlagen (Text ungültig).");
      }
    });
  }

  // Controls
  btnToday.addEventListener("click", ()=>{
    const now = new Date();
    const y = Math.max(START_YEAR, Math.min(END_YEAR, now.getFullYear()));
    selYear.value = String(y);
    selMonth.value = String(now.getMonth());
    renderMonth();
  });

  btnClearMonth.addEventListener("click", ()=>{
    const ok = confirm("Diesen Monat wirklich löschen?");
    if(!ok) return;

    const year = parseInt(selYear.value,10);
    const m0 = parseInt(selMonth.value,10);
    const dim = daysInMonth(year,m0);

    for(let d=1; d<=dim; d++){
      const key = iso(year,m0+1,d);
      if(db[key]) delete db[key];
    }
    saveDB();
    renderMonth();
  });

  selYear.addEventListener("change", renderMonth);
  selMonth.addEventListener("change", renderMonth);

  // Boot
  fillSelectors();
  const now = new Date();
  selYear.value = String(Math.max(START_YEAR, Math.min(END_YEAR, now.getFullYear())));
  selMonth.value = String(now.getMonth());
  renderMonth();
})();
</script>
</body>
</html>
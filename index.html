<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Namastakip</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121824;
      --panel2:#0f1520;
      --text:#e8eef7;
      --muted:#9fb0c7;
      --line:#223049;
      --green:#2ee59d;
      --black:#0a0a0a;
      --danger:#ff5a6a;

      --cell:42px;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(900px 600px at 10% 0%, #0f1a2e 0%, var(--bg) 55%);
      color:var(--text);
    }

    header{
      position: sticky;
      top:0;
      z-index:20;
      background: linear-gradient(180deg, rgba(11,15,20,.96), rgba(11,15,20,.78));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      max-width: 1200px;
      margin:0 auto;
    }

    .title h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .title .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      min-width: 280px;
    }
    .btn, select{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(18,24,36,.95), rgba(15,21,32,.95));
      color:var(--text);
      border-radius: 12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    select{ padding:10px 10px; }
    .btn{
      cursor:pointer;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.danger{
      border-color: rgba(255,90,106,.45);
      background: linear-gradient(180deg, rgba(255,90,106,.18), rgba(255,90,106,.10));
    }

    main{
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 14px 40px;
      display:grid;
      grid-template-columns: 1.6fr .9fr;
      gap:14px;
    }

    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
      .controls{ justify-content:flex-start; min-width:unset; }
    }

    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(18,24,36,.96), rgba(15,21,32,.96));
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
    }
    .card .hd b{ font-size:14px; letter-spacing:.2px; }
    .card .bd{ padding:12px; }

    .help{
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      margin:0 0 8px 0;
    }

    /* ===== TABLE WRAP (wichtig fÃ¼rs iPhone) ===== */
    .tableWrap{
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
      border:1px solid var(--line);
    }

    table{
      width:100%;
      min-width: 760px; /* sorgt dafÃ¼r, dass Gebets-Spalten nicht kollabieren */
      border-collapse: separate;
      border-spacing:0;
      background: rgba(0,0,0,0);
    }

    thead th{
      position: sticky;
      top:0;
      z-index:5;
      background: rgba(18,24,36,.98);
      border-bottom:1px solid var(--line);
    }

    th, td{
      padding:10px 10px;
      text-align:center;
      font-size:14px;
      border-bottom:1px solid rgba(34,48,73,.55);
    }

    th:first-child, td:first-child{
      text-align:left;
      position: sticky;
      left:0;
      z-index:4;
      background: rgba(18,24,36,.98);
      border-right:1px solid rgba(34,48,73,.55);
      min-width: 170px;
    }

    tbody tr:hover td{
      background: rgba(255,255,255,.02);
    }
    tbody tr:hover td:first-child{
      background: rgba(18,24,36,.98);
    }

    .phead{
      font-size:12px;
      color:var(--muted);
      letter-spacing:.2px;
    }

    .cellBtn{
      width: var(--cell);
      height: var(--cell);
      border-radius: 12px;
      border:1px solid rgba(34,48,73,.65);
      background: rgba(0,0,0,.14);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      cursor:pointer;
      user-select:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .cellBtn:active{ transform: translateY(1px); }

    .state-0{ color: transparent; } /* leer */
    .state-1{
      color:#0b1a14;
      background: linear-gradient(180deg, rgba(46,229,157,.95), rgba(46,229,157,.65));
      border-color: rgba(46,229,157,.55);
      box-shadow: 0 6px 14px rgba(46,229,157,.16);
    }
    .state-2{
      color:#fff;
      background: linear-gradient(180deg, rgba(10,10,10,.95), rgba(10,10,10,.75));
      border-color: rgba(255,255,255,.18);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .grid2{ grid-template-columns:1fr; }
    }

    .pillRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      padding:10px 12px;
      border-radius: 999px;
      min-width: 150px;
      justify-content:space-between;
    }
    .pill .k{ color:var(--muted); font-size:13px; }
    .pill .v{ font-weight:700; font-size:15px; }
    .pill .dot{
      width:10px;height:10px;border-radius:99px;background: var(--green);
      box-shadow: 0 0 0 4px rgba(46,229,157,.12);
    }
    .dot.black{ background:#cfd6e6; box-shadow: 0 0 0 4px rgba(255,255,255,.08); }

    .roses{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .rose{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width: 180px;
      padding:12px 14px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
    }
    .rose .label{ display:flex; align-items:center; gap:10px; }
    .rose .count{ font-weight:800; font-size:16px; }
    .rose.red{ border-color: rgba(255,90,106,.35); }
    .rose.white{ border-color: rgba(255,255,255,.18); }

    .backupBox textarea{
      width:100%;
      min-height: 140px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 10px;
      font-size:12px;
      outline:none;
      resize: vertical;
    }
    .backupBtns{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }

    .note{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
      margin-top:8px;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      color:var(--muted);
      font-size:12px;
    }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="title">
      <h1>Namastakip</h1>
      <div class="sub">
        Tippen = Status wechseln: <b>leer</b> â†’ <span style="color:var(--green);font-weight:700;">ðŸŸ¢</span> (pÃ¼nktlich/Eda) â†’ <span style="font-weight:700;">âš«</span> (Kaza).<br>
        Daten werden auf deinem Handy gespeichert.
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="btnToday">Heute</button>

      <span class="tag">Jahr:
        <select id="selYear"></select>
      </span>

      <span class="tag">Monat:
        <select id="selMonth"></select>
      </span>

      <button class="btn danger" id="btnClearMonth">Monat lÃ¶schen</button>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="hd">
      <b>Tabelle</b>
      <span class="tag" id="rangeLabel">Zeitraum: â€“</span>
    </div>

    <div class="bd">
      <p class="help">
        Bedienung: Tippe auf ein Feld (Sabah / Ã–ÄŸle / Ä°kindi / AkÅŸam / YatsÄ±). Jeder Tipp wechselt den Status:
        <b>leer</b> â†’ <span style="color:var(--green);font-weight:700;">ðŸŸ¢</span> â†’ <b>âš«</b> â†’ leer.
      </p>

      <div class="tableWrap" id="tableWrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Datum</th>
              <th class="phead">Sabah</th>
              <th class="phead">Ã–ÄŸle</th>
              <th class="phead">Ä°kindi</th>
              <th class="phead">AkÅŸam</th>
              <th class="phead">YatsÄ±</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <aside class="card">
    <div class="hd">
      <b>Tracker</b>
      <span class="tag">Eda / Kaza</span>
    </div>

    <div class="bd">
      <div class="grid2">
        <div class="card" style="border-radius:12px;">
          <div class="hd"><b>âœ… PÃ¼nktlich (Eda)</b></div>
          <div class="bd" id="edaList" style="padding-top:10px;"></div>
        </div>

        <div class="card" style="border-radius:12px;">
          <div class="hd"><b>âš« Kaza</b></div>
          <div class="bd" id="kazaList" style="padding-top:10px;"></div>
        </div>
      </div>

      <div style="height:12px;"></div>

      <div class="card" style="border-radius:12px;">
        <div class="hd"><b>Tage mit Rosen</b></div>
        <div class="bd">
          <div class="roses">
            <div class="rose red">
              <div class="label"><span>ðŸŒ¹</span><b style="color:var(--danger)">Rot</b></div>
              <div class="count" id="roseRed">0</div>
            </div>
            <div class="rose white">
              <div class="label"><span>ðŸŒ¹</span><b>WeiÃŸ</b></div>
              <div class="count" id="roseWhite">0</div>
            </div>
          </div>
          <div class="note">
            Rot: alle 5 <b>Eda</b> Â· WeiÃŸ: alle 5 erledigt, aber nicht komplett Eda (mind. 1 Kaza)
          </div>
        </div>
      </div>

      <div style="height:12px;"></div>

      <div class="card backupBox" style="border-radius:12px;">
        <div class="hd"><b>Backup (optional)</b></div>
        <div class="bd">
          <div class="help">Du kannst deine Daten exportieren/importieren (fÃ¼r Backup oder GerÃ¤tewechsel).</div>
          <textarea id="backupText" placeholder="Hier erscheint Export-Textâ€¦ (oder fÃ¼ge Import-Text ein)"></textarea>

          <div class="backupBtns">
            <button class="btn" id="btnExport">Export</button>
            <button class="btn" id="btnImport">Import</button>
            <button class="btn danger" id="btnClearAll">Alles lÃ¶schen</button>
          </div>

          <div class="note">
            Hinweis: â€žAlles lÃ¶schenâ€œ entfernt nur die gespeicherten Daten auf diesem GerÃ¤t.
          </div>
        </div>
      </div>
    </div>
  </aside>
</main>

<script>
(() => {
  // ====== Konfiguration ======
  const START_YEAR = 2002;
  const END_YEAR   = 2030;

  const PRAYERS = [
    { key: "sabah",  label: "Sabah" },
    { key: "ogle",   label: "Ã–ÄŸle" },
    { key: "ikindi", label: "Ä°kindi" },
    { key: "aksam",  label: "AkÅŸam" },
    { key: "yatsi",  label: "YatsÄ±" }
  ];

  // status: 0 leer, 1 eda(ðŸŸ¢), 2 kaza(âš«)
  const DB_KEY = "namastakip_v2";

  // ====== Helpers ======
  const pad2 = (n) => String(n).padStart(2, "0");
  const isoDate = (y,m,d) => `${y}-${pad2(m)}-${pad2(d)}`; // m=1..12
  const weekdayShort = (dateObj) => {
    const map = ["So","Mo","Di","Mi","Do","Fr","Sa"];
    return map[dateObj.getDay()];
  };
  const monthName = (m0) => {
    const map = ["Jan","Feb","MÃ¤r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];
    return map[m0] || "";
  };

  function daysInMonth(year, month0){
    // month0: 0..11
    return new Date(year, month0 + 1, 0).getDate();
  }

  // ====== DB ======
  // Struktur:
  // db[dateISO] = { sabah:0|1|2, ogle:0|1|2, ... }
  let db = {};
  try{
    db = JSON.parse(localStorage.getItem(DB_KEY) || "{}") || {};
  }catch(e){
    db = {};
  }

  function saveDB(){
    localStorage.setItem(DB_KEY, JSON.stringify(db));
  }

  function ensureDay(dateISO){
    if(!db[dateISO]){
      db[dateISO] = {};
      for(const p of PRAYERS) db[dateISO][p.key] = 0;
    }else{
      for(const p of PRAYERS){
        if(typeof db[dateISO][p.key] !== "number") db[dateISO][p.key] = 0;
      }
    }
    return db[dateISO];
  }

  function setStatus(dateISO, prayerKey, status){
    const day = ensureDay(dateISO);
    day[prayerKey] = status;
    saveDB();
  }

  function cycleStatus(dateISO, prayerKey){
    const day = ensureDay(dateISO);
    const cur = day[prayerKey] || 0;
    const next = (cur + 1) % 3;
    day[prayerKey] = next;
    saveDB();
  }

  function clearMonth(year, month0){
    // Entfernt nur EintrÃ¤ge innerhalb dieses Monats
    const start = new Date(year, month0, 1);
    const end = new Date(year, month0 + 1, 1);
    const startISO = isoDate(year, month0+1, 1);

    const toDelete = [];
    for(const k of Object.keys(db)){
      const dt = new Date(k + "T00:00:00");
      if(!isNaN(dt) && dt >= start && dt < end) toDelete.push(k);
    }
    for(const k of toDelete) delete db[k];
    saveDB();
  }

  function clearAll(){
    db = {};
    saveDB();
  }

  // ====== UI Elements ======
  const selYear = document.getElementById("selYear");
  const selMonth = document.getElementById("selMonth");
  const btnToday = document.getElementById("btnToday");
  const btnClearMonth = document.getElementById("btnClearMonth");
  const rangeLabel = document.getElementById("rangeLabel");

  const tbody = document.getElementById("tbody");

  const edaList = document.getElementById("edaList");
  const kazaList = document.getElementById("kazaList");
  const roseRedEl = document.getElementById("roseRed");
  const roseWhiteEl = document.getElementById("roseWhite");

  const backupText = document.getElementById("backupText");
  const btnExport = document.getElementById("btnExport");
  const btnImport = document.getElementById("btnImport");
  const btnClearAll = document.getElementById("btnClearAll");

  // ====== Populate selectors ======
  function fillSelectors(){
    selYear.innerHTML = "";
    for(let y = END_YEAR; y >= START_YEAR; y--){
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      selYear.appendChild(opt);
    }

    selMonth.innerHTML = "";
    for(let m0 = 0; m0 < 12; m0++){
      const opt = document.createElement("option");
      opt.value = String(m0);
      opt.textContent = `${pad2(m0+1)} ${monthName(m0)}`;
      selMonth.appendChild(opt);
    }
  }

  function setToToday(){
    const now = new Date();
    const y = now.getFullYear();
    const m0 = now.getMonth();
    // clamp year
    const yy = Math.max(START_YEAR, Math.min(END_YEAR, y));
    selYear.value = String(yy);
    selMonth.value = String(m0);
    renderMonth();
    // nach oben in Tabelle
    document.getElementById("tableWrap")?.scrollTo({left:0, top:0, behavior:"smooth"});
  }

  // ====== Render Month ======
  function renderMonth(){
    const year = parseInt(selYear.value, 10);
    const month0 = parseInt(selMonth.value, 10);
    const dim = daysInMonth(year, month0);

    const startISO = isoDate(year, month0+1, 1);
    const endISO = isoDate(year, month0+1, dim);
    rangeLabel.textContent = `Zeitraum: ${startISO} bis ${endISO} (WÃ¤hle Jahr/Monat fÃ¼r 2002â€“2030)`;

    // build rows
    const frag = document.createDocumentFragment();

    for(let d=1; d<=dim; d++){
      const dateObj = new Date(year, month0, d);
      const dateISO = isoDate(year, month0+1, d);
      const day = ensureDay(dateISO);

      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.textContent = `${weekdayShort(dateObj)} ${pad2(d)}.${pad2(month0+1)}.${year}`;
      tr.appendChild(tdDate);

      // 5 prayer cells
      for(const p of PRAYERS){
        const td = document.createElement("td");
        const btn = document.createElement("div");
        btn.className = "cellBtn " + statusClass(day[p.key] || 0);
        btn.textContent = statusSymbol(day[p.key] || 0);

        btn.addEventListener("click", () => {
          cycleStatus(dateISO, p.key);
          // Update only this cell + trackers (fast)
          const newDay = ensureDay(dateISO);
          const st = newDay[p.key] || 0;
          btn.className = "cellBtn " + statusClass(st);
          btn.textContent = statusSymbol(st);
          updateTrackersForCurrentMonth();
        });

        td.appendChild(btn);
        tr.appendChild(td);
      }

      frag.appendChild(tr);
    }

    tbody.innerHTML = "";
    tbody.appendChild(frag);

    updateTrackersForCurrentMonth();
  }

  function statusClass(st){
    if(st === 1) return "state-1";
    if(st === 2) return "state-2";
    return "state-0";
  }
  function statusSymbol(st){
    if(st === 1) return "âœ“"; // pÃ¼nktlich
    if(st === 2) return "âœ“"; // kaza (schwarz per CSS)
    return "â€¢"; // wird transparent (state-0)
  }

  // ====== Trackers ======
  function updateTrackersForCurrentMonth(){
    const year = parseInt(selYear.value, 10);
    const month0 = parseInt(selMonth.value, 10);
    const dim = daysInMonth(year, month0);

    const edaCounts = Object.fromEntries(PRAYERS.map(p => [p.key, 0]));
    const kazaCounts = Object.fromEntries(PRAYERS.map(p => [p.key, 0]));

    let roseRed = 0;
    let roseWhite = 0;

    for(let d=1; d<=dim; d++){
      const dateISO = isoDate(year, month0+1, d);
      const day = ensureDay(dateISO);

      let doneAll = true;
      let edaAll = true;

      for(const p of PRAYERS){
        const st = day[p.key] || 0;
        if(st === 1) edaCounts[p.key] += 1;
        if(st === 2) kazaCounts[p.key] += 1;

        if(st === 0) doneAll = false;
        if(st !== 1) edaAll = false;
      }

      if(doneAll && edaAll) roseRed += 1;
      else if(doneAll && !edaAll) roseWhite += 1;
    }

    // render lists
    edaList.innerHTML = "";
    kazaList.innerHTML = "";

    for(const p of PRAYERS){
      edaList.appendChild(makePill(p.label, edaCounts[p.key], false));
      kazaList.appendChild(makePill(p.label, kazaCounts[p.key], true));
    }

    roseRedEl.textContent = String(roseRed);
    roseWhiteEl.textContent = String(roseWhite);
  }

  function makePill(label, value, isBlack){
    const wrap = document.createElement("div");
    wrap.className = "pill";
    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.alignItems = "center";
    left.style.gap = "10px";

    const dot = document.createElement("span");
    dot.className = "dot" + (isBlack ? " black" : "");
    left.appendChild(dot);

    const k = document.createElement("span");
    k.className = "k";
    k.textContent = label;
    left.appendChild(k);

    const v = document.createElement("span");
    v.className = "v";
    v.textContent = String(value);

    wrap.appendChild(left);
    wrap.appendChild(v);
    return wrap;
  }

  // ====== Backup ======
  btnExport.addEventListener("click", () => {
    backupText.value = JSON.stringify(db);
    backupText.focus();
    backupText.select();
  });

  btnImport.addEventListener("click", () => {
    const txt = (backupText.value || "").trim();
    if(!txt){
      alert("Bitte zuerst Import-Text einfÃ¼gen.");
      return;
    }
    let obj;
    try{
      obj = JSON.parse(txt);
    }catch(e){
      alert("Import-Text ist kein gÃ¼ltiges JSON.");
      return;
    }
    if(typeof obj !== "object" || obj === null){
      alert("Import-Text ist ungÃ¼ltig.");
      return;
    }
    // sehr einfache Validierung
    db = obj;
    saveDB();
    renderMonth();
    alert("Import abgeschlossen.");
  });

  btnClearAll.addEventListener("click", () => {
    const ok = confirm("Wirklich ALLE gespeicherten Daten lÃ¶schen?");
    if(!ok) return;
    clearAll();
    renderMonth();
  });

  // ====== Buttons ======
  btnToday.addEventListener("click", setToToday);

  btnClearMonth.addEventListener("click", () => {
    const ok = confirm("Diesen Monat wirklich lÃ¶schen?");
    if(!ok) return;
    const year = parseInt(selYear.value, 10);
    const month0 = parseInt(selMonth.value, 10);
    clearMonth(year, month0);
    renderMonth();
  });

  selYear.addEventListener("change", renderMonth);
  selMonth.addEventListener("change", renderMonth);

  // ====== Boot ======
  fillSelectors();

  // initial: heutiger Monat, aber in Range clamp
  const now = new Date();
  let initYear = now.getFullYear();
  let initMonth0 = now.getMonth();
  if(initYear < START_YEAR) initYear = START_YEAR;
  if(initYear > END_YEAR) initYear = END_YEAR;

  selYear.value = String(initYear);
  selMonth.value = String(initMonth0);

  renderMonth();
})();
</script>
</body>
</html>



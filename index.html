<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Namastakip</title>

<style>
:root{
  --bg1:#35d0d6;
  --bg2:#0aa0a8;
  --panel:rgba(8,20,24,.75);
  --panel2:rgba(8,20,24,.6);
  --text:#ecfbff;
  --muted:#c9f3f7;
  --line:rgba(255,255,255,.18);

  --kaza:#111;        /* schwarz */
  --farz:#ff5a5a;    /* rot */
  --sunnet:#ffd84d;  /* gelb */
  --cemaat:#35e38f;  /* grÃ¼n */

  --cell:40px;
  --radius:14px;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
}

header{
  position:sticky; top:0; z-index:10;
  background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.15));
  backdrop-filter:blur(8px);
  border-bottom:1px solid var(--line);
}

.top{
  max-width:1100px;
  margin:auto;
  padding:12px;
}

h1{margin:0;font-size:20px}
.sub{font-size:13px;color:var(--muted);margin-top:6px}

main{
  max-width:1100px;
  margin:auto;
  padding:12px;
}

.card{
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:12px;
}

table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
}

th,td{
  text-align:center;
  padding:6px 4px;
  border-bottom:1px solid var(--line);
  font-size:13px;
}

th:first-child,td:first-child{
  text-align:left;
  width:140px;
}

.cell{
  width:var(--cell);
  height:var(--cell);
  border-radius:10px;
  border:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  user-select:none;
}

.cell.kaza{background:var(--kaza)}
.cell.farz{background:var(--farz)}
.cell.sunnet{background:var(--sunnet); color:#000}
.cell.cemaat{background:var(--cemaat)}

.controls{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

button,select{
  background:rgba(0,0,0,.2);
  color:var(--text);
  border:1px solid var(--line);
  border-radius:10px;
  padding:8px 10px;
}
button{cursor:pointer}
</style>
</head>
<body>
<header>
  <div class="top">
    <h1>Namastakip</h1>
    <div class="sub">
      Tippen = Status wechseln:
      â¬› Kaza â†’ ðŸ”´ Farz â†’ ðŸŸ¡ SÃ¼nnet+Wajib â†’ ðŸŸ¢ Cemaat
    </div>
  </div>
</header>

<main>
<div class="card">
  <div class="controls">
    <button id="btnToday">Heute</button>

    <select id="selYear"></select>
    <select id="selMonth"></select>

    <button id="btnClearMonth">Monat lÃ¶schen</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Datum</th>
        <th>Sabah</th>
        <th>Ã–ÄŸle</th>
        <th>Ä°kindi</th>
        <th>AkÅŸam</th>
        <th>YatsÄ±</th>
        <th>Vitir (Wajib)</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="sub" style="margin-top:10px">
    Hinweis: Alles speichert automatisch auf deinem Handy. FÃ¼r â€žewiges Archivâ€œ kommt im Backup-Bereich ein Speichern-Button.
  </div>
</div>

<!-- Rechte Box (ZÃ¤hler + Backup) kommt in Teil 3 -->
<div class="card" style="margin-top:12px">
  <h3 style="margin:0 0 8px 0; font-size:15px;">ZÃ¤hler & Backup</h3>
  <div class="sub">Kommt gleich in Teil 3 (Balken + Speichern + Export/Import).</div>
</div>

<script>
(() => {
  // ====== KONFIG ======
  const START_YEAR = 2002;
  const END_YEAR   = 2030;

  const PRAYERS = [
    { key:"sabah",  label:"Sabah" },
    { key:"ogle",   label:"Ã–ÄŸle" },
    { key:"ikindi", label:"Ä°kindi" },
    { key:"aksam",  label:"AkÅŸam" },
    { key:"yatsi",  label:"YatsÄ±" },
    { key:"vitir",  label:"Vitir" },
  ];

  // Status: 0 leer, 1 Kaza (schwarz), 2 Farz (rot), 3 SÃ¼nnet+Wajib (gelb), 4 Cemaat (grÃ¼n)
  const statusClass = (s) =>
    s===1 ? "kaza" : s===2 ? "farz" : s===3 ? "sunnet" : s===4 ? "cemaat" : "";

  const statusSymbol = (s) => s===0 ? "" : "âœ“";

  const DB_KEY = "namastakip_v4_db";
  let db = {};
  try{ db = JSON.parse(localStorage.getItem(DB_KEY) || "{}") || {}; }catch(e){ db = {}; }

  // ====== HELPERS ======
  const pad2 = (n) => String(n).padStart(2,"0");
  const iso = (y,m,d) => `${y}-${pad2(m)}-${pad2(d)}`;
  const daysInMonth = (y,m0) => new Date(y, m0+1, 0).getDate();
  const wd = (dateObj) => ["So","Mo","Di","Mi","Do","Fr","Sa"][dateObj.getDay()];
  const monthName = (m0) => ["Jan","Feb","MÃ¤r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"][m0];
  const fmtDE = (dateObj) => `${wd(dateObj)} ${pad2(dateObj.getDate())}.${pad2(dateObj.getMonth()+1)}.${dateObj.getFullYear()}`;

  function ensureDay(dateISO){
    if(!db[dateISO]){
      db[dateISO] = {};
      for(const p of PRAYERS) db[dateISO][p.key] = 0;
    } else {
      for(const p of PRAYERS){
        if(typeof db[dateISO][p.key] !== "number") db[dateISO][p.key] = 0;
      }
    }
    return db[dateISO];
  }

  function saveDB(){
    localStorage.setItem(DB_KEY, JSON.stringify(db));
  }

  // ====== UI ======
  const selYear = document.getElementById("selYear");
  const selMonth = document.getElementById("selMonth");
  const tbody = document.getElementById("tbody");
  const btnToday = document.getElementById("btnToday");
  const btnClearMonth = document.getElementById("btnClearMonth");

  function fillSelectors(){
    selYear.innerHTML = "";
    for(let y=END_YEAR; y>=START_YEAR; y--){
      const o = document.createElement("option");
      o.value = String(y);
      o.textContent = String(y);
      selYear.appendChild(o);
    }

    selMonth.innerHTML = "";
    for(let m0=0; m0<12; m0++){
      const o = document.createElement("option");
      o.value = String(m0);
      o.textContent = `${pad2(m0+1)} ${monthName(m0)}`;
      selMonth.appendChild(o);
    }
  }

  function renderMonth(){
    const year = parseInt(selYear.value,10);
    const m0 = parseInt(selMonth.value,10);
    const dim = daysInMonth(year,m0);

    const frag = document.createDocumentFragment();
    tbody.innerHTML = "";

    for(let d=1; d<=dim; d++){
      const dateObj = new Date(year,m0,d);
      const dateISO = iso(year,m0+1,d);
      const rec = ensureDay(dateISO);

      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.textContent = fmtDE(dateObj);
      tr.appendChild(tdDate);

      for(const p of PRAYERS){
        const td = document.createElement("td");
        const div = document.createElement("div");
        div.className = "cell " + statusClass(rec[p.key]||0);
        div.textContent = statusSymbol(rec[p.key]||0);

        div.addEventListener("click", () => {
          const day = ensureDay(dateISO);
          const cur = day[p.key] || 0;
          const next = (cur + 1) % 5; // 0->1->2->3->4->0
          day[p.key] = next;

          div.className = "cell " + statusClass(next);
          div.textContent = statusSymbol(next);

          saveDB();
          // ZÃ¤hler/Balken/Backup aktualisieren kommt in Teil 3
          if(typeof window.__namastakipUpdateAll === "function") window.__namastakipUpdateAll();
        });

        td.appendChild(div);
        tr.appendChild(td);
      }

      frag.appendChild(tr);
    }

    tbody.appendChild(frag);

    if(typeof window.__namastakipUpdateAll === "function") window.__namastakipUpdateAll();
  }

  btnToday.addEventListener("click", () => {
    const now = new Date();
    selYear.value = String(now.getFullYear());
    selMonth.value = String(now.getMonth());
    renderMonth();
  });

  btnClearMonth.addEventListener("click", () => {
    const ok = confirm("Diesen Monat wirklich lÃ¶schen?");
    if(!ok) return;

    const year = parseInt(selYear.value,10);
    const m0 = parseInt(selMonth.value,10);
    const dim = daysInMonth(year,m0);

    for(let d=1; d<=dim; d++){
      const key = iso(year,m0+1,d);
      if(db[key]) delete db[key];
    }
    saveDB();
    renderMonth();
  });

  selYear.addEventListener("change", renderMonth);
  selMonth.addEventListener("change", renderMonth);

  // ====== BOOT ======
  fillSelectors();
  const now = new Date();
  const y = Math.max(START_YEAR, Math.min(END_YEAR, now.getFullYear()));
  selYear.value = String(y);
  selMonth.value = String(now.getMonth());
  renderMonth();

  // Export fÃ¼r Teil 3
  window.__namastakipDB = {
    get(){ return db; },
    set(next){ db = next || {}; saveDB(); renderMonth(); },
    save: saveDB
  };
})();
</script>
<script>
(() => {
  // ====== Einstellungen (Pflicht ab 10 Jahren, Geburt 1998 default) ======
  const SETTINGS_KEY = "namastakip_v4_settings";
  const DB_KEY = "namastakip_v4_db"; // muss zu Teil 2 passen

  const PRAYERS_PER_DAY = 6; // 5 + Vitir
  const obligationAge = 10;

  let settings = { birthDate: "1998-01-01" };
  try{
    const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "null");
    if(s && typeof s === "object") settings = { ...settings, ...s };
  }catch(e){}

  function saveSettings(){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  }

  // ====== UI in rechter Box ersetzen (wir nutzen die vorhandene zweite Card) ======
  // Wir suchen die zweite Card im main (die "ZÃ¤hler & Backup" Box) und ersetzen deren Inhalt
  const cards = document.querySelectorAll("main .card");
  const rightCard = cards[cards.length - 1]; // die zweite card (unter der Tabelle)
  rightCard.innerHTML = `
    <h3 style="margin:0 0 8px 0; font-size:15px;">ZÃ¤hler & Archiv</h3>

    <div class="sub" style="margin:0 0 10px 0;">
      Pflicht pro Tag: <b>${PRAYERS_PER_DAY}</b> (Sabah, Ã–ÄŸle, Ä°kindi, AkÅŸam, YatsÄ±, Vitir).
      Tippen-Zyklus: â¬› Kaza â†’ ðŸ”´ Farz â†’ ðŸŸ¡ SÃ¼nnet+Wajib â†’ ðŸŸ¢ Cemaat â†’ leer
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
      <span class="pill">Geburt: <input id="birthDate" type="date" style="padding:6px 8px; border-radius:10px;" /></span>
      <button id="btnApplyBirth">Ãœbernehmen</button>
    </div>

    <div style="border:1px solid var(--line); border-radius:12px; padding:10px; background:rgba(0,0,0,.12);">
      <div class="sub" style="margin:0 0 6px 0;"><b>Gesamt-Fortschritt seit Pflicht</b></div>
      <div style="display:grid; gap:6px; font-size:13px;">
        <div style="display:flex; justify-content:space-between; gap:10px;">
          <span>Pflicht seit</span><b id="sinceLabel">â€“</b>
        </div>
        <div style="display:flex; justify-content:space-between; gap:10px;">
          <span>NÃ¶tig (Gebete)</span><b id="needLabel">0</b>
        </div>
        <div style="display:flex; justify-content:space-between; gap:10px;">
          <span>Erledigt</span><b id="doneLabel">0</b>
        </div>
        <div style="display:flex; justify-content:space-between; gap:10px;">
          <span>Noch offen</span><b id="leftLabel">0</b>
        </div>
      </div>

      <div style="margin-top:10px; height:12px; border-radius:999px; border:1px solid var(--line); background:rgba(0,0,0,.18); overflow:hidden;">
        <div id="barFill" style="height:100%; width:0%; background:linear-gradient(90deg, rgba(90,209,255,.95), rgba(46,229,157,.95));"></div>
      </div>
    </div>

    <div style="height:12px;"></div>

    <div style="border:1px solid var(--line); border-radius:12px; padding:10px; background:rgba(0,0,0,.12);">
      <div class="sub" style="margin:0 0 8px 0;"><b>Tracker (gesamt)</b></div>
      <div id="trackers" style="display:grid; gap:6px;"></div>
    </div>

    <div style="height:12px;"></div>

    <div style="border:1px solid var(--line); border-radius:12px; padding:10px; background:rgba(0,0,0,.12);">
      <div class="sub" style="margin:0 0 6px 0;"><b>Backup (ewiges Archiv)</b></div>
      <div class="sub" style="margin:0 0 10px 0;">
        FÃ¼r neues Handy: <b>Backup speichern</b> â†’ in Dateien/iCloud ablegen â†’ spÃ¤ter <b>Backup laden</b>.
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="btnSaveFile">Backup speichern</button>
        <button id="btnLoadFile">Backup laden</button>
        <button id="btnExportText">Export (Text)</button>
        <button id="btnImportText">Import (Text)</button>
      </div>

      <textarea id="backupText" placeholder="Export-Text erscheint hierâ€¦ oder Import-Text einfÃ¼gen"></textarea>

      <div class="sub" style="margin-top:8px;">
        Autospeichern ist immer aktiv. Der Backup-Button ist die Extra-Sicherheit.
      </div>
    </div>

    <input id="filePicker" type="file" accept="application/json" style="display:none" />
  `;

  // ====== Elemente ======
  const birthDate = document.getElementById("birthDate");
  const btnApplyBirth = document.getElementById("btnApplyBirth");

  const sinceLabel = document.getElementById("sinceLabel");
  const needLabel  = document.getElementById("needLabel");
  const doneLabel  = document.getElementById("doneLabel");
  const leftLabel  = document.getElementById("leftLabel");
  const barFill    = document.getElementById("barFill");
  const trackersEl = document.getElementById("trackers");

  const btnSaveFile = document.getElementById("btnSaveFile");
  const btnLoadFile = document.getElementById("btnLoadFile");
  const filePicker  = document.getElementById("filePicker");
  const btnExportText = document.getElementById("btnExportText");
  const btnImportText = document.getElementById("btnImportText");
  const backupText = document.getElementById("backupText");

  birthDate.value = settings.birthDate || "1998-01-01";
  btnApplyBirth.addEventListener("click", () => {
    if(!birthDate.value) return alert("Bitte Geburtsdatum auswÃ¤hlen.");
    settings.birthDate = birthDate.value;
    saveSettings();
    updateAll();
    alert("Gespeichert âœ…");
  });

  // ====== Pflicht-Start berechnen ======
  function obligationStart(){
    const bd = (settings.birthDate || "1998-01-01").split("-").map(n=>parseInt(n,10));
    const start = new Date(bd[0] + obligationAge, (bd[1]-1), bd[2]);
    start.setHours(0,0,0,0);
    return start;
  }

  function isoToday(d){
    const pad2 = (n) => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  // ====== ZÃ¤hlen: erledigt / tracker ======
  const PRAYER_KEYS = ["sabah","ogle","ikindi","aksam","yatsi","vitir"];
  const LABELS = { sabah:"Sabah", ogle:"Ã–ÄŸle", ikindi:"Ä°kindi", aksam:"AkÅŸam", yatsi:"YatsÄ±", vitir:"Vitir" };

  function updateAll(){
    // Daten holen
    const raw = (window.__namastakipDB && window.__namastakipDB.get) ? window.__namastakipDB.get() : {};
    const db = raw || {};

    // Tracker gesamt nach Status
    const counts = {};
    for(const k of PRAYER_KEYS){
      counts[k] = { kaza:0, farz:0, sunnet:0, cemaat:0 };
    }

    // Erledigt = status 1..4
    let doneTotal = 0;
    for(const dateISO in db){
      const rec = db[dateISO];
      if(!rec || typeof rec !== "object") continue;
      for(const k of PRAYER_KEYS){
        const v = rec[k] || 0;
        if(v >= 1 && v <= 4) doneTotal++;
        if(v === 1) counts[k].kaza++;
        if(v === 2) counts[k].farz++;
        if(v === 3) counts[k].sunnet++;
        if(v === 4) counts[k].cemaat++;
      }
    }

    // NÃ¶tig = Tage seit Pflicht * 6 (bis heute inkl.)
    const start = obligationStart();
    const today = new Date(); today.setHours(0,0,0,0);

    let daysReq = 0;
    if(start <= today){
      daysReq = Math.floor((today - start) / 86400000) + 1;
    }
    const needTotal = daysReq * PRAYERS_PER_DAY;
    const left = Math.max(0, needTotal - doneTotal);
    const pct = needTotal > 0 ? Math.min(100, (doneTotal / needTotal) * 100) : 0;

    sinceLabel.textContent = isoToday(start);
    needLabel.textContent  = String(needTotal);
    doneLabel.textContent  = String(doneTotal);
    leftLabel.textContent  = String(left);
    barFill.style.width = `${pct.toFixed(2)}%`;

    // Tracker UI
    trackersEl.innerHTML = "";
    for(const k of PRAYER_KEYS){
      const row = document.createElement("div");
      row.style.display = "grid";
      row.style.gridTemplateColumns = "70px 1fr";
      row.style.gap = "10px";
      row.style.alignItems = "center";
      row.style.padding = "8px 10px";
      row.style.border = "1px solid var(--line)";
      row.style.borderRadius = "12px";
      row.style.background = "rgba(0,0,0,.10)";

      const left = document.createElement("div");
      left.innerHTML = `<b>${LABELS[k]}</b>`;
      left.style.color = "var(--muted)";
      left.style.fontSize = "13px";

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.flexWrap = "wrap";
      right.style.gap = "6px";

      right.appendChild(tag("â¬›", counts[k].kaza));
      right.appendChild(tag("ðŸ”´", counts[k].farz));
      right.appendChild(tag("ðŸŸ¡", counts[k].sunnet));
      right.appendChild(tag("ðŸŸ¢", counts[k].cemaat));

      row.appendChild(left);
      row.appendChild(right);
      trackersEl.appendChild(row);
    }

    function tag(emoji, n){
      const s = document.createElement("span");
      s.className = "pill";
      s.textContent = `${emoji} ${n}`;
      return s;
    }
  }

  // Expose for Part 2
  window.__namastakipUpdateAll = updateAll;
  updateAll();

  // ====== Backup als Datei ======
  btnSaveFile.addEventListener("click", () => {
    const payload = {
      version: 4,
      savedAt: new Date().toISOString(),
      settings,
      db: (window.__namastakipDB && window.__namastakipDB.get) ? window.__namastakipDB.get() : {}
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
    const now = new Date();
    const pad2 = (n) => String(n).padStart(2,"0");
    const stamp = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
    const filename = `namastakip-backup-${stamp}.json`;

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
  });

  btnLoadFile.addEventListener("click", () => {
    filePicker.value = "";
    filePicker.click();
  });

  filePicker.addEventListener("change", async () => {
    const f = filePicker.files && filePicker.files[0];
    if(!f) return;

    try{
      const txt = await f.text();
      const obj = JSON.parse(txt);

      if(!obj || typeof obj !== "object") throw new Error("ungÃ¼ltig");
      if(obj.settings) settings = { ...settings, ...obj.settings };
      if(obj.db && window.__namastakipDB && window.__namastakipDB.set){
        window.__namastakipDB.set(obj.db);
      } else if(obj.db){
        localStorage.setItem(DB_KEY, JSON.stringify(obj.db));
      }

      saveSettings();
      birthDate.value = settings.birthDate || "1998-01-01";
      updateAll();
      alert("Backup geladen âœ…");
    }catch(e){
      alert("Backup konnte nicht geladen werden (ungÃ¼ltige Datei).");
    }
  });

  // ====== Export/Import als Text ======
  btnExportText.addEventListener("click", () => {
    const payload = {
      version: 4,
      savedAt: new Date().toISOString(),
      settings,
      db: (window.__namastakipDB && window.__namastakipDB.get) ? window.__namastakipDB.get() : {}
    };
    backupText.value = JSON.stringify(payload);
    backupText.focus();
    backupText.select();
  });

  btnImportText.addEventListener("click", () => {
    const txt = (backupText.value || "").trim();
    if(!txt) return alert("Bitte zuerst Import-Text einfÃ¼gen.");

    try{
      const obj = JSON.parse(txt);
      if(!obj || typeof obj !== "object") throw new Error("ungÃ¼ltig");

      if(obj.settings) settings = { ...settings, ...obj.settings };
      if(obj.db && window.__namastakipDB && window.__namastakipDB.set){
        window.__namastakipDB.set(obj.db);
      }

      saveSettings();
      birthDate.value = settings.birthDate || "1998-01-01";
      updateAll();
      alert("Import abgeschlossen âœ…");
    }catch(e){
      alert("Import fehlgeschlagen: ungÃ¼ltiger Text.");
    }
  });

  // ====== Ende HTML schlieÃŸen ======
})();
</script>

</main>
</body>
</html>
